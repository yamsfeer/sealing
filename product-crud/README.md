# CRUD 功能经验

## 新增和编辑不应该使用同一个组件

新增商品和编辑商品的表单多数时候是非常类似的，如果使用同一个组件，然后用 isEdit 这类 props 来判断是新增还是编辑，这会带来很多麻烦。

应该用一个 product-form 组件负责展示表单，但不负责新增和编辑的逻辑，新增和编辑分别再用两个组件来处理。这样一来，组件的边界和功能会更加清晰，定位问题也更容易。

## 当组件的 prop 是一个表单的对象

根据单向数据流，product-form 不应该直接修改 product-create 和 product-update 传递的 product 对象，而是应该复制一份 product 对象并作为 product-form 的数据绑定，product-form 点击确定时，将这个新的对象 emit 出去。这会使得 product-form 的功能非常单一且稳定。

## 如果新增和编辑的表单不同

可以传递一个 json 给 product-form，用于配置表单项。

## 传递子组件的 prop 是一个对象，却不自动更新， 例如 编辑

页面不更新
vue-devtool 需要手动刷新才更新

这可能与 Vue Devtools 的缓存或刷新机制有关。

### 原因

如果是修改对象内属性，vue 默认的 diff 算法是 shallow 的，如果 prop 是一个对象，那么默认不会更新，需要手动指定 deep
如果传递的是整个对象，

1. Vue 的更新机制未正确检测到变化：Vue 通常会自动检测到 props 的变化并触发子组件的重新渲染，但某些情况下，可能会由于变化不够明显或其他原因而未正确检测到。在这种情况下，你可以尝试使用 key 属性，如前面的示例所示，以强制重新渲染子组件。

2. 子组件内部存在性能优化：如果子组件内部实现了一些性能优化策略，可能会导致子组件不会在每次 props 变化时都进行完全的重新渲染。这可能是出于性能优化的目的，但也可能导致你的需求不满足。在这种情况下，你需要检查子组件的代码，看是否有这样的优化策略存在。

如果你在 Vue Devtools 中可以观察到子组件的 prop 已经更新，但子组件自身没有重新渲染，这可能是由于 Vue 的一些优化策略导致的。

当 Vue 更新一个组件时，它会执行一系列的优化策略，其中包括避免不必要的重新渲染。在某些情况下，Vue 可能会认为组件的重新渲染不是必要的，因为只有 props 发生变化，并且组件内部状态没有发生变化。在这种情况下，Vue 可能会选择仅更新 props，而不重新渲染整个组件。

这并不一定是一个问题，因为 Vue 的优化策略旨在提高性能。如果你确实需要在 props 变化时强制组件重新渲染，你可以使用 key 属性，如前面提到的方法，来告诉 Vue 强制重新创建组件实例。这将确保即使 props 变化不明显，也会触发组件的完全重新渲染。

### 解决办法

- 用对象的 JSON 序列字符串作为一个 key，以便在 formData 变化时强制子组件重新创建。

### 总结

总之，Vue 的更新机制通常是自动的且可靠的，但在一些特殊情况下，可能需要额外的手动干预来确保子组件按预期进行重新渲染。如果你的问题还没有解决，建议进一步检查子组件内部是否有其他因素干扰了重新渲染，并确保更新的变化明显可检测。如果问题仍然存在，可能需要深入调试以找出具体原因。

[参考](https://github.com/vuejs/core/issues/3562)

## 注意事项

### 默认 vue 导出不支持 template

```javascript
import { createApp } from 'vue'
```

相当于

```javascript
import { createApp } from 'vue/dist/vue.runtime.esm-bundler'
```

应该用

```javascript
import { createApp } from 'vue/dist/vue.esm-bundler'
```

这个才是带 compiler 的 vue。

### suspense

Suspense 可以等待的异步依赖有两种：

* 带有异步 setup() 钩子的组件。这也包含了使用 `<script setup>` 时有顶层 await 表达式的组件。
* 异步组件。

### 其他

vue3 + ts + setup 的使用

todo

- 理解 props 的更新逻辑
- 理解 reactive 对象与组件更新间的关系

* computed
* watch 和 watchEffect 的区别

## 表单模块的要点

- 基本 CRUD - 问题：对象在 dialog 组件上的传递
- 表单校验 - 如何封装表单校验
- 表单联动
- 表单重置

* 用 json 配置对象生成表单

- 表单中有文件相关操作时 - 比如文件上传

* 尝试一下引入 mock
